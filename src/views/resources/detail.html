{% extends "base.html" %}

{% block title %}{{ resource.title }} - Campus Resource Hub{% endblock %}

{% block content %}
<div class="container mt-4">
    {% if return_to == 'approvals' %}
    <div class="mb-3">
        <a href="{{ url_for('admin.approvals') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Approvals Queue
        </a>
    </div>
    {% endif %}
    {% if resource.status == 'draft' %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> <strong>Pending Approval:</strong> This resource is currently pending admin approval and is not visible to other users. It will appear on the site once an admin approves it.
    </div>
    {% endif %}
    <div class="row">
        <!-- Left Column: Resource Details -->
        <div class="col-lg-8">
            <!-- Images -->
            <div class="card mb-4">
                {% if images_parsed and images_parsed[0] %}
                    {% set image_url = images_parsed[0] %}
                    <img src="{{ image_url }}" class="card-img-top" alt="{{ resource.title }}" 
                         style="max-height: 400px; object-fit: cover;" 
                         onerror="console.error('Failed to load image:', '{{ image_url }}'); this.src='https://via.placeholder.com/800x400?text=No+Image'">
                {% else %}
                <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 400px;">
                    <span class="text-white fs-4">No Image Available</span>
                </div>
                {% endif %}
            </div>

            <!-- Resource Info -->
            <div class="card mb-4">
                <div class="card-body">
                    <h1 class="card-title">{{ resource.title }}</h1>
                    <div class="mb-3">
                        {% if resource.category %}
                        <span class="badge bg-primary me-2">{{ resource.category }}</span>
                        {% endif %}
                        {% if resource.capacity %}
                        <span class="badge bg-info me-2">Capacity: {{ resource.capacity }}</span>
                        {% endif %}
                        <span class="badge bg-{% if resource.status == 'published' %}success{% elif resource.status == 'draft' %}warning{% else %}secondary{% endif %}">
                            {{ resource.status }}
                        </span>
                    </div>
                    {% if resource.location %}
                    <p class="text-muted">
                        üìç {{ resource.location }}
                    </p>
                    {% endif %}
                    {% if resource.description %}
                    <div class="mt-3">
                        <h5>Description</h5>
                        <p>{{ resource.description|replace('\n', '<br>')|safe }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Availability Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Availability & Bookings</h5>
                </div>
                <div class="card-body">
                    {% if availability_rules_parsed and availability_rules_parsed is mapping %}
                        <div class="mb-3">
                            <h6>Regular Hours</h6>
                            <ul class="list-unstyled">
                                {% for day, hours in availability_rules_parsed.items() %}
                                <li><strong>{{ day|title }}:</strong> {{ hours }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    
                    {% if bookings %}
                    <div>
                        <h6>Upcoming Bookings</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for booking in bookings[:10] %}
                                    <tr>
                                        <td>{{ booking.start_datetime.strftime('%b %d, %Y') }}</td>
                                        <td>
                                            {{ booking.start_datetime.strftime('%I:%M %p') }} - 
                                            {{ booking.end_datetime.strftime('%I:%M %p') }}
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if booking.status == 'approved' %}success{% elif booking.status == 'pending' %}warning{% else %}secondary{% endif %}">
                                                {{ booking.status }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if bookings|length > 10 %}
                        <p class="text-muted small">Showing 10 of {{ bookings|length }} bookings</p>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="text-muted">No upcoming bookings scheduled.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Reviews & Ratings</h5>
                    {% if review_stats and review_stats.total_reviews > 0 %}
                    <div>
                        <span class="text-warning">
                            {% for i in range(5) %}
                                {% if i < review_stats.average_rating|round|int %}
                                ‚òÖ
                                {% else %}
                                ‚òÜ
                                {% endif %}
                            {% endfor %}
                        </span>
                        <span class="text-muted ms-2">
                            {{ "%.1f"|format(review_stats.average_rating) }} ({{ review_stats.total_reviews }})
                        </span>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if preview_reviews and preview_reviews|length > 0 %}
                        {% for review in preview_reviews %}
                        <div class="mb-3 {% if not loop.last %}border-bottom pb-3{% endif %}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <strong class="d-block">{{ review.reviewer.name if review.reviewer else 'Anonymous' }}</strong>
                                    <div class="text-warning small">
                                        {% for i in range(5) %}
                                            {% if i < review.rating %}
                                            ‚òÖ
                                            {% else %}
                                            ‚òÜ
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                <small class="text-muted">{{ review.timestamp.strftime('%Y-%m-%d') }}</small>
                            </div>
                            {% if review.comment %}
                            <p class="mb-0 text-muted small">{{ review.comment }}</p>
                            {% else %}
                            <p class="mb-0 text-muted small"><em>No comment provided</em></p>
                            {% endif %}
                        </div>
                        {% endfor %}
                        
                        {% if total_reviews_count > 3 %}
                        <div class="mt-3 text-center">
                            <a href="{{ url_for('reviews.index', resource_id=resource.resource_id) }}" class="btn btn-outline-primary btn-sm">
                                View All Reviews ({{ total_reviews_count }} total)
                            </a>
                        </div>
                        {% else %}
                        <div class="mt-3 text-center">
                            <a href="{{ url_for('reviews.index', resource_id=resource.resource_id) }}" class="btn btn-outline-primary btn-sm">
                                View All Reviews
                            </a>
                        </div>
                        {% endif %}
                    {% else %}
                        <p class="text-muted mb-3">No reviews yet. Be the first to review this resource!</p>
                        <a href="{{ url_for('reviews.index', resource_id=resource.resource_id) }}" class="btn btn-outline-primary btn-sm">
                            View All Reviews
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Booking -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-body">
                    <h5 class="card-title">Book This Resource</h5>
                    
                    <!-- Show availability days and times -->
                    {% if availability_rules_parsed and availability_rules_parsed is mapping and availability_rules_parsed|length > 0 %}
                    <div class="mb-3">
                        <h6 class="small text-muted mb-2">Available Times:</h6>
                        <div class="small">
                            {% for day, hours in availability_rules_parsed.items() %}
                            <div class="mb-1">
                                <strong>{{ day|title }}:</strong> {{ hours }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <hr>
                    {% endif %}
                    
                    {% if current_user.is_authenticated %}
                        {% if resource.owner_id == current_user.user_id %}
                        <div class="alert alert-info">
                            <small>This is your resource. You can edit it below.</small>
                        </div>
                        {% else %}
                        <a href="{{ url_for('bookings.create', resource_id=resource.resource_id) }}" 
                           class="btn btn-primary w-100 mb-3">
                            <i class="bi bi-calendar-check"></i> Book Now
                        </a>
                        {% endif %}
                    {% else %}
                    <div class="alert alert-warning">
                        <a href="{{ url_for('auth.login') }}">Sign in</a> to book this resource.
                    </div>
                    {% endif %}

                    <hr>

                    <!-- Availability Summary -->
                    {% if availability_summary %}
                    <div class="mb-3">
                        <h6>Availability Overview</h6>
                        <div class="small">
                            {% set total_avail = availability_summary|sum(attribute='available_slots') %}
                            {% if total_avail > 0 %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Available days:</span>
                                <span class="badge bg-success">
                                    {{ total_avail }} {{ 'slot' if total_avail == 1 else 'slots' }} open
                                </span>
                            </div>
                            {% endif %}
                            <div class="availability-mini-calendar">
                                {% for day_info in availability_summary %}
                                <div class="availability-day-item mb-1">
                                    <span class="text-muted">{{ day_info.day_name[:3] }} {{ day_info.date.strftime('%m/%d') }}:</span>
                                    <span class="ms-2">
                                        {% if day_info.available_slots > 0 %}
                                            <span class="badge bg-success">{{ day_info.available_slots }} {{ 'slot' if day_info.available_slots == 1 else 'slots' }} open</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Fully booked</span>
                                        {% endif %}
                                    </span>
                                </div>
                                {% endfor %}
                            </div>
                            {% if availability_summary|length == 0 %}
                            <p class="text-muted small mb-0">No availability scheduled</p>
                            {% endif %}
                        </div>
                    </div>
                    <hr>
                    {% endif %}

                    <!-- Waitlist Section -->
                    {% if current_user.is_authenticated and resource.owner_id != current_user.user_id %}
                        {% if user_waitlist_entry %}
                        <div class="alert alert-info mb-3">
                            <h6 class="alert-heading">You're on the Waitlist</h6>
                            <p class="small mb-2">
                                Position: <strong>#{{ user_waitlist_position }}</strong><br>
                                Requested: {{ user_waitlist_entry.requested_datetime.strftime('%B %d, %Y at %I:%M %p') }}
                            </p>
                            {% if waitlist_count > 1 %}
                            <p class="small text-muted mb-0">
                                {{ waitlist_count }} people waiting
                            </p>
                            {% endif %}
                            <form method="POST" action="{{ url_for('bookings.leave_waitlist', waitlist_id=user_waitlist_entry.waitlist_id) }}" 
                                  class="mt-2"
                                  onsubmit="return confirm('Are you sure you want to leave the waitlist?');">
                                <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                                    Leave Waitlist
                                </button>
                            </form>
                        </div>
                        {% else %}
                        <div class="mb-3" id="waitlist-section">
                            <h6>Join Waitlist</h6>
                            <p class="small text-muted mb-2">
                                Get notified when this resource becomes available for your preferred time.
                            </p>
                            {% if waitlist_count > 0 %}
                            <p class="small text-muted mb-2">
                                <i class="bi bi-people"></i> {{ waitlist_count }} {{ 'person is' if waitlist_count == 1 else 'people are' }} waiting
                            </p>
                            {% endif %}
                            <form method="POST" action="{{ url_for('bookings.join_waitlist', resource_id=resource.resource_id) }}" id="waitlist-form">
                                <div class="mb-2">
                                    <label for="waitlist_datetime" class="form-label small">When do you need it? *</label>
                                    <input type="datetime-local" 
                                           class="form-control form-control-sm" 
                                           id="waitlist_datetime" 
                                           name="requested_datetime" 
                                           required>
                                    <small class="text-muted d-block mt-1" id="waitlist-availability-check"></small>
                                </div>
                                <button type="submit" class="btn btn-outline-primary btn-sm w-100" id="waitlist-submit-btn">
                                    <i class="bi bi-clock-history"></i> Join Waitlist
                                </button>
                            </form>
                        </div>
                        <hr>
                        {% endif %}
                    {% endif %}

                    <h6>Resource Owner</h6>
                    <p class="small">
                        {% if resource.owner %}
                        <strong>{{ resource.owner.name }}</strong><br>
                        {% if resource.owner.department %}
                        {{ resource.owner.department }}<br>
                        {% endif %}
                        {% if resource.owner.email %}
                        <a href="mailto:{{ resource.owner.email }}">{{ resource.owner.email }}</a>
                        {% endif %}
                        {% else %}
                        Unknown
                        {% endif %}
                    </p>
                    {% if current_user.is_authenticated and resource.owner and resource.owner_id != current_user.user_id %}
                    <a href="{{ url_for('messages.conversation', user_id=resource.owner_id) }}" 
                       class="btn btn-outline-primary btn-sm w-100 mt-2">
                        <i class="bi bi-envelope"></i> Message Owner
                    </a>
                    {% endif %}

                    {% if current_user.is_authenticated %}
                        {% if resource.owner_id == current_user.user_id or current_user.role == 'admin' %}
                        <hr>
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('resources.edit', resource_id=resource.resource_id) }}" 
                               class="btn btn-outline-primary btn-sm">Edit Resource</a>
                            {% if current_user.role == 'admin' or resource.owner_id == current_user.user_id %}
                            <form method="POST" action="{{ url_for('resources.delete', resource_id=resource.resource_id) }}" 
                                  onsubmit="return confirm('Are you sure you want to delete this resource?');">
                                <button type="submit" class="btn btn-outline-danger btn-sm w-100">Delete Resource</button>
                            </form>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Check availability when user selects a datetime for waitlist
document.addEventListener('DOMContentLoaded', function() {
    const waitlistDatetimeInput = document.getElementById('waitlist_datetime');
    const availabilityCheck = document.getElementById('waitlist-availability-check');
    const waitlistSubmitBtn = document.getElementById('waitlist-submit-btn');
    const waitlistForm = document.getElementById('waitlist-form');
    const resourceId = {{ resource.resource_id }};
    
    if (waitlistDatetimeInput) {
        waitlistDatetimeInput.addEventListener('change', function() {
            const selectedDatetime = this.value;
            if (!selectedDatetime) {
                availabilityCheck.textContent = '';
                waitlistSubmitBtn.disabled = false;
                return;
            }
            
            // Parse the datetime
            const selectedDate = new Date(selectedDatetime);
            const dateStr = selectedDate.toISOString().split('T')[0];
            
            // Check availability via API
            fetch(`/api/time-slots/${resourceId}?date=${dateStr}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        availabilityCheck.textContent = 'Error checking availability';
                        availabilityCheck.className = 'text-danger d-block mt-1';
                        waitlistSubmitBtn.disabled = true;
                        return;
                    }
                    
                    // Check if the selected time slot is available
                    const selectedTime = selectedDate.toTimeString().slice(0, 5); // HH:MM format
                    let isAvailable = false;
                    
                    if (data.all_slots) {
                        // Find matching slot
                        for (const slot of data.all_slots) {
                            if (slot.start === selectedTime && slot.available) {
                                isAvailable = true;
                                break;
                            }
                        }
                    }
                    
                    if (isAvailable) {
                        availabilityCheck.textContent = '‚úì This time slot is available! You can book it directly instead.';
                        availabilityCheck.className = 'text-success d-block mt-1';
                        waitlistSubmitBtn.disabled = true;
                        waitlistSubmitBtn.innerHTML = '<i class="bi bi-calendar-check"></i> Time Available - Book Instead';
                        waitlistSubmitBtn.classList.remove('btn-outline-primary');
                        waitlistSubmitBtn.classList.add('btn-success');
                    } else {
                        const availableCount = data.available_slots ? data.available_slots.length : 0;
                        if (availableCount > 0) {
                            availabilityCheck.textContent = `‚ö† This time slot is booked. ${availableCount} other time slots are available today.`;
                            availabilityCheck.className = 'text-warning d-block mt-1';
                        } else {
                            availabilityCheck.textContent = 'This time slot is fully booked. You can join the waitlist.';
                            availabilityCheck.className = 'text-info d-block mt-1';
                        }
                        waitlistSubmitBtn.disabled = false;
                        waitlistSubmitBtn.innerHTML = '<i class="bi bi-clock-history"></i> Join Waitlist';
                        waitlistSubmitBtn.classList.remove('btn-success');
                        waitlistSubmitBtn.classList.add('btn-outline-primary');
                    }
                })
                .catch(error => {
                    console.error('Error checking availability:', error);
                    availabilityCheck.textContent = 'Error checking availability. Please try again.';
                    availabilityCheck.className = 'text-danger d-block mt-1';
                    waitlistSubmitBtn.disabled = false;
                });
        });
        
        // Prevent form submission if time is available
        if (waitlistForm) {
            waitlistForm.addEventListener('submit', function(e) {
                if (waitlistSubmitBtn.disabled || waitlistSubmitBtn.classList.contains('btn-success')) {
                    e.preventDefault();
                    // Redirect to booking page instead
                    window.location.href = '{{ url_for("bookings.create", resource_id=resource.resource_id) }}';
                    return false;
                }
            });
        }
    }
});
</script>
{% endblock %}

