{% extends "base.html" %}

{% block title %}Dashboard - Campus Resource Hub{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Dashboard</h1>
    <p class="lead">Welcome, {{ current_user.name }}!</p>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">My Resources</h5>
                    <h2 class="text-primary">{{ current_user.resources|length }}</h2>
                    <a href="{{ url_for('resources.index') }}?owner={{ current_user.user_id }}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">My Bookings</h5>
                    <h2 class="text-info">{{ current_user.bookings|length }}</h2>
                    <a href="#bookings" class="btn btn-sm btn-outline-info">View All</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Messages</h5>
                    <h2 class="text-success">
                        {% if total_unread and total_unread > 0 %}
                            <span class="badge bg-danger rounded-pill">{{ total_unread }}</span>
                            <small class="text-muted d-block mt-1">unread</small>
                        {% else %}
                            <span class="text-muted">0</span>
                            <small class="text-muted d-block mt-1">unread</small>
                        {% endif %}
                    </h2>
                    <a href="{{ url_for('messages.index') }}" class="btn btn-sm btn-outline-success">View All</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">My Reviews</h5>
                    <h2 class="text-warning">{{ current_user.reviews|length }}</h2>
                    <a href="{{ url_for('reviews.my_reviews') }}" class="btn btn-sm btn-outline-warning">View All</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Role Change Request Section -->
    {% if current_user.role == 'student' %}
    <div class="card mb-4">
        <div class="card-header">
            <h5>Request Role Change</h5>
        </div>
        <div class="card-body">
            {% if pending_role_request %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> <strong>Pending Request:</strong> You have a pending request to change your role to <strong>{{ pending_role_request.requested_role|title }}</strong>. 
                An admin will review your request soon.
                {% if pending_role_request.reason %}
                <br><br><strong>Your reason:</strong> {{ pending_role_request.reason }}
                {% endif %}
            </div>
            {% else %}
            <p>Need Staff or Admin access? Request a role change below.</p>
            <form method="POST" action="{{ url_for('auth.request_role_change') }}">
                <div class="mb-3">
                    <label for="requested_role" class="form-label">Requested Role</label>
                    <select class="form-select" id="requested_role" name="requested_role" required>
                        <option value="">Select a role...</option>
                        <option value="staff">Staff</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="reason" class="form-label">Reason (Optional)</label>
                    <textarea class="form-control" id="reason" name="reason" rows="3" 
                              placeholder="Please explain why you need this role change..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-person-check"></i> Submit Request
                </button>
            </form>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Quick Actions</h5>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
                <a href="{{ url_for('resources.create') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Resource
                </a>
                <a href="{{ url_for('resources.index') }}" class="btn btn-outline-primary">
                    <i class="bi bi-search"></i> Browse Resources
                </a>
                <a href="{{ url_for('messages.index') }}" class="btn btn-outline-primary">
                    <i class="bi bi-envelope"></i> Messages
                </a>
                {% if current_user.role == 'admin' %}
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-danger">
                    <i class="bi bi-shield-check"></i> Admin Panel
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- My Resources -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>My Resources</h5>
            <a href="{{ url_for('resources.create') }}" class="btn btn-sm btn-primary">Add New</a>
        </div>
        <div class="card-body">
            {% if current_user.resources %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for resource in current_user.resources[:5] %}
                        <tr>
                            <td><a href="{{ url_for('resources.detail', resource_id=resource.resource_id) }}">{{ resource.title }}</a></td>
                            <td>{{ resource.category or 'N/A' }}</td>
                            <td><span class="badge bg-{% if resource.status == 'published' %}success{% elif resource.status == 'draft' %}warning{% else %}secondary{% endif %}">{{ resource.status }}</span></td>
                            <td>
                                <a href="{{ url_for('resources.edit', resource_id=resource.resource_id) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <a href="{{ url_for('resources.index') }}?owner={{ current_user.user_id }}" class="btn btn-sm btn-outline-primary">View All Resources</a>
            {% else %}
            <p class="text-muted">You haven't created any resources yet.</p>
            <a href="{{ url_for('resources.create') }}" class="btn btn-primary">Create Your First Resource</a>
            {% endif %}
        </div>
    </div>

    <!-- My Bookings -->
    <div class="card mb-4" id="bookings">
        <div class="card-header">
            <h5>My Recent Bookings</h5>
        </div>
        <div class="card-body">
            {% if current_user.bookings %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Resource</th>
                            <th>Date & Time</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in current_user.bookings[:5] %}
                        <tr>
                            <td>
                                {% if booking.resource %}
                                <a href="{{ url_for('resources.detail', resource_id=booking.resource_id) }}">{{ booking.resource.title }}</a>
                                {% else %}
                                Resource #{{ booking.resource_id }}
                                {% endif %}
                            </td>
                            <td>
                                {{ booking.start_datetime.strftime('%Y-%m-%d %H:%M') }} - 
                                {{ booking.end_datetime.strftime('%H:%M') }}
                            </td>
                            <td>
                                <span class="badge bg-{% if booking.status == 'approved' %}success{% elif booking.status == 'pending' %}warning{% elif booking.status == 'rejected' %}danger{% else %}secondary{% endif %}">
                                    {{ booking.status }}
                                </span>
                            </td>
                            <td>
                                <a href="{{ url_for('bookings.detail', booking_id=booking.booking_id) }}" class="btn btn-sm btn-outline-primary">View</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">You don't have any bookings yet.</p>
            <a href="{{ url_for('resources.index') }}" class="btn btn-primary">Browse Resources</a>
            {% endif %}
        </div>
    </div>

    <!-- My Reviews -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>My Reviews</h5>
            <a href="{{ url_for('reviews.my_reviews') }}" class="btn btn-sm btn-outline-warning">View All</a>
        </div>
        <div class="card-body">
            {% if current_user.reviews %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Resource</th>
                            <th>Rating</th>
                            <th>Comment</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for review in current_user.reviews[:5] %}
                        <tr>
                            <td>
                                {% if review.resource %}
                                <a href="{{ url_for('resources.detail', resource_id=review.resource_id) }}">{{ review.resource.title }}</a>
                                {% else %}
                                Resource #{{ review.resource_id }}
                                {% endif %}
                            </td>
                            <td>
                                {% for i in range(5) %}
                                <span class="text-{% if i < review.rating %}warning{% else %}muted{% endif %}">â˜…</span>
                                {% endfor %}
                                <span class="text-muted ms-1">({{ review.rating }}/5)</span>
                            </td>
                            <td>
                                {% if review.comment %}
                                <span class="text-truncate d-inline-block" style="max-width: 200px;" title="{{ review.comment }}">
                                    {{ review.comment }}
                                </span>
                                {% else %}
                                <span class="text-muted">No comment</span>
                                {% endif %}
                            </td>
                            <td>{{ review.timestamp.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <a href="{{ url_for('reviews.edit', review_id=review.review_id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">You haven't written any reviews yet.</p>
            <p class="text-muted small">After booking and using a resource, you can leave a review to help others!</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}


